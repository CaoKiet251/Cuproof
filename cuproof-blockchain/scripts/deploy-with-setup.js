const { ethers } = require("hardhat");
const fs = require("fs");
const path = require("path");

async function main() {
  console.log("ğŸš€ Starting Cuproof contracts deployment...");
  
  // Get accounts
  const [owner, verifier1, verifier2, subject1, subject2] = await ethers.getSigners();
  
  console.log("ğŸ“‹ Accounts:");
  console.log("  Owner:", owner.address);
  console.log("  Verifier 1:", verifier1.address);
  console.log("  Verifier 2:", verifier2.address);
  console.log("  Subject 1:", subject1.address);
  console.log("  Subject 2:", subject2.address);
  
  // Deploy CuproofRegistry
  console.log("\nğŸ“¦ Deploying CuproofRegistry...");
  const CuproofRegistry = await ethers.getContractFactory("CuproofRegistry");
  const registry = await CuproofRegistry.deploy();
  await registry.deployed();
  
  console.log("âœ… CuproofRegistry deployed to:", registry.address);
  
  // Deploy CuproofVerifier
  console.log("\nğŸ“¦ Deploying CuproofVerifier...");
  const initialParamsHash = ethers.utils.keccak256(
    ethers.utils.defaultAbiCoder.encode(["string"], ["development-params"])
  );
  
  const CuproofVerifier = await ethers.getContractFactory("CuproofVerifier");
  const verifier = await CuproofVerifier.deploy(initialParamsHash);
  await verifier.deployed();
  
  console.log("âœ… CuproofVerifier deployed to:", verifier.address);
  
  // Add authorized verifiers
  console.log("\nğŸ‘¥ Adding authorized verifiers...");
  await verifier.addVerifier(verifier1.address);
  await verifier.addVerifier(verifier2.address);
  
  console.log("âœ… Added verifiers:", verifier1.address, verifier2.address);
  
  // Update public parameters in registry
  console.log("\nâš™ï¸  Setting up public parameters...");
  const g = ethers.utils.keccak256(ethers.utils.toUtf8Bytes("generator-g"));
  const h = ethers.utils.keccak256(ethers.utils.toUtf8Bytes("generator-h"));
  const n = ethers.utils.keccak256(ethers.utils.toUtf8Bytes("modulus-n"));
  
  await registry.updatePublicParams(g, h, n, "Development parameters for Cuproof system");
  
  console.log("âœ… Public parameters set");
  
  // Save deployment info
  const deploymentInfo = {
    network: "hardhat-local",
    chainId: 31337,
    timestamp: new Date().toISOString(),
    contracts: {
      CuproofRegistry: {
        address: registry.address,
        owner: owner.address,
        publicParams: { g, h, n }
      },
      CuproofVerifier: {
        address: verifier.address,
        owner: owner.address,
        publicParamsHash: initialParamsHash,
        authorizedVerifiers: [verifier1.address, verifier2.address]
      }
    },
    accounts: {
      owner: owner.address,
      verifiers: [verifier1.address, verifier2.address],
      subjects: [subject1.address, subject2.address]
    },
    rpcUrl: "http://localhost:8545",
    blockExplorer: ""
  };
  
  fs.writeFileSync(
    path.join(__dirname, "deployment-info.json"),
    JSON.stringify(deploymentInfo, null, 2)
  );
  
  console.log("\nğŸ“„ Deployment info saved to deployment-info.json");
  
  // Create environment file for web app
  const envContent = `# Cuproof Web Application Environment Variables
# Generated by deployment script

NEXT_PUBLIC_CUPROOF_VERIFIER_ADDRESS=${verifier.address}
NEXT_PUBLIC_CUPROOF_REGISTRY_ADDRESS=${registry.address}
NEXT_PUBLIC_NETWORK_CHAIN_ID=31337
NEXT_PUBLIC_DEBUG=true

# Test accounts (for development only)
NEXT_PUBLIC_OWNER_ADDRESS=${owner.address}
NEXT_PUBLIC_VERIFIER_1_ADDRESS=${verifier1.address}
NEXT_PUBLIC_VERIFIER_2_ADDRESS=${verifier2.address}
NEXT_PUBLIC_SUBJECT_1_ADDRESS=${subject1.address}
NEXT_PUBLIC_SUBJECT_2_ADDRESS=${subject2.address}
`;
  
  fs.writeFileSync(
    path.join(__dirname, "../cuproof-web-app/.env.local"),
    envContent
  );
  
  console.log("ğŸ“„ Environment file created for web app");
  
  // Summary
  console.log("\nğŸ‰ Deployment completed successfully!");
  console.log("=====================================");
  console.log("ğŸ“‹ Contract Addresses:");
  console.log("  CuproofRegistry:", registry.address);
  console.log("  CuproofVerifier:", verifier.address);
  console.log("\nğŸ‘¥ Test Accounts:");
  console.log("  Owner:", owner.address);
  console.log("  Verifiers:", verifier1.address, verifier2.address);
  console.log("  Subjects:", subject1.address, subject2.address);
  console.log("\nğŸŒ Network Info:");
  console.log("  RPC URL: http://localhost:8545");
  console.log("  Chain ID: 31337");
  console.log("\nğŸ“± Next Steps:");
  console.log("  1. Start the web app: cd ../cuproof-web-app && npm run dev");
  console.log("  2. Open http://localhost:3000 in your browser");
  console.log("  3. Connect MetaMask to Hardhat network");
  console.log("  4. Import test accounts using the mnemonic:");
  console.log("     test test test test test test test test test test test junk");
}

main()
  .then(() => process.exit(0))
  .catch((error) => {
    console.error("âŒ Deployment failed:", error);
    process.exit(1);
  });
